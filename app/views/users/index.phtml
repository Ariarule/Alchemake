<?php $this->flashSession->output();

function trade_table($trade,$possible_actions) {
    $trade_details = ['FROM_PROPOSER' => [], 'TO_PROPOSER' => []];
    foreach ($trade->tradeDetails as $trade_detail) {
        $trade_details[$trade_detail->direction][] = $trade_detail;
    }
    echo "<table><thead><tr><td>{$trade->proposer->nickname}</td>";
    echo "<td>{$trade->proposed->nickname}</td></tr></thead><tbody>";
    foreach ($trade_details as $party_trade_details) {
        echo "<td><ul>";
        foreach ($party_trade_details as $trade_detail) {
            echo "<li>{$trade_detail->qty}x {$trade_detail->Items->name}</li>";
        }
        echo "</ul></td>";
    }
    echo "</tbody></table>";
    echo '<form method="POST"><input type="hidden" name="tradeid"';
    echo " value=\"\">";
    foreach ($possible_actions as $possible_action) {
        echo "<button type=\"submit\" formmethod=\"{$possible_action}\">"
        . ucwords($possible_action) . "</button>";
    }
    echo "</form>";
}

echo "<h2>Welcome {$userinfo->nickname}</h2>";
$possible_f = ['T' => function () use ($userinfo) { //trades
    echo "<h3>Trades</h3>";
    $trade_types = [['field' => 'proposer',
                        'label' => 'You have suggested:',
                        'actions' => ['withdraw']],
                    ['field' => 'proposed',
                        'label' => 'Others have suggested:',
                        'actions' => ['reject', 'counteroffer']]];
        foreach ($trade_types as $trade_type) {
            echo "<h4>{$trade_type['label']}</h4>";
            $trades = Trades::findAcceptableByUserId($userinfo->userid,
                    $trade_type['field']);
            if ($trades->count() > 0) {
                foreach ($trades as $trade) {
                    trade_table($trade, $trade_type['actions']);
                }
            }
            else {
                echo "...no pending trades.";
            }
        }
    //print_r();
  },

  'I' => function () use ($userinfo) { //inventory
    echo "<h3>Your Inventory</h3>";

    if ($userinfo->inventory->count() > 0) {
     $form_buttons = '<button formaction="/Trade/setupProposal" type="submit">Trade</button>&nbsp;'
     . '<button formaction="/Inventory/alchemake" type="submit">Alchemake'
     .'</button>';
     $this->partial('shared/inventoryTable',
        ['form_buttons' => $form_buttons,
         'inventory' => $userinfo->inventory]);
}
else {
  echo "You have no inventory right now. :(";
}   

  },

  'U' => function () use ($userinfo) { //usercard
    ?><!--
    <?php echo "{$userinfo->userid}"; ?>
    -->
    <h3>Usercard</h3>
    <div id="userinfo">
      <ul>
        <li>Basic item delivery: <?= explode($userinfo->last_drop,' ')[0] ?></li>
        <li>AY Allowence: <?= explode($userinfo->last_allowence,' ')[0] ?></li>
        <li>Email Address: <?= $userinfo->emailaddress ?></li>
      </ul>
    </div>
    <?php
  }];

foreach (str_split($userinfo->main_order,1) as $section) {
  if (isset($possible_f[$section])) {
    $possible_f[$section]();
  }
}
?>
